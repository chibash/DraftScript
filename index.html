<html>
<head>
  <meta charset="UTF-8"/>
  <title>DraftScript</title>
  <script src="lib/codemirror.js"></script>
  <link rel="stylesheet" href="lib/codemirror.css">
  <link rel="stylesheet" href="addon/hint/show-hint.css">
  <script src="mode/javascript/javascript.js"></script>
  <script src="addon/edit/matchbrackets.js"></script>
  <script src="addon/hint/show-hint.js"></script>
  <script src="addon/hint/javascript-hint.js"></script>
  <script src="keymap/emacs.js"></script>

  <script>
    // Copyright (C) 2019 by Shigeru Chiba.
    'use strict';

    const DraftScript = new class {
      constructor() {
        this.editorArea = null;
        this.class_name = 'draftscript';
        this.consoleText = '';
      }

      onload() {
        const sample = '';

        const editor = document.getElementById('editor');
        this.editorArea = CodeMirror(editor, {
          mode: 'javascript',
          value: sample,
          lineNumbers: true,
          keyMap: 'emacs',
          matchBrackets: true,
          extraKeys: { 'Shift-Enter': function(cm){ DraftScript.run(); },
                       'Ctrl-Space': 'autocomplete' },
        });

        this.resizeCanvas();
        this.editorArea.setSize('100%', '400px');
        this.editorArea.focus();
      }

      resizeCanvas() {
        const editor = document.getElementById('editor');
        let w = document.body.clientWidth - editor.clientWidth - 50;
        if (w < 370)
          w = 500;
        else if (w < 400)
          w = 400;

        const c = document.getElementById('canvas');
        c.width = w;
        c.height = w;
      }

      run() {
        const src = this.editorArea.getDoc().getValue();
        if (src === '')
          return;

          let success = true
        let result = null
        try {
          result = eval(src);
        }
        catch (e) {
          success = false
          result = e
          DraftScript.turtleCmd.pushAlert('エラー：プログラムを実行できません\n' + e);
        }
        DraftScript.turtleCmd.pushEnd(src, success, result)
        this.consoleText = ''
        const ctx = document.getElementById('canvas').getContext('2d');
        DraftScript.turtleCmd.runTurtle(ctx)
        this.editorArea.focus();
      }


      print(value) {
        const value2 = this.escapeHTML(value) + '<br/>';
        this.consoleText += value2;
        const out = document.getElementById('output');
        out.innerText += value + '\n';
      }

      end_running(src, success, result) {
        const cells = document.getElementById('cells');
        cells.innerHTML += "<pre style='padding: 5px; width: 50em; border: 0.5px solid gray;'>" + this.escapeHTML(src) + '</pre><p>';
        cells.innerHTML += this.consoleText;
        if (result !== undefined)
          cells.innerHTML += this.escapeHTML(result)

        cells.innerHTML += '</p>'
        if (success)
          this.editorArea.getDoc().setValue('')

        const out = document.getElementById('output');
        out.innerText = ''
        this.editorArea.focus();
        document.getElementById('canvas').scrollIntoView(false);
      }

      reset() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        DraftScript.turtleCmd.reset();
        this.editorArea.focus();
      }

      save() {
        const program = this.editorArea.getDoc().getValue();
        if (program != null
            && confirm('今編集中のプログラムを保存しますか？\n' +
                       '以前保存したプログラムは消去されます。')) {
          localStorage.setItem(this.class_name, JSON.stringify(program));
          this.editorArea.focus();
        }
      }

      load() {
        const program = localStorage.getItem(this.class_name);
        if (program != null
            && confirm('保存済みのプログラムを開きますか？\n' +
                       '今編集中のプログラムは消去されます。')) {
          this.editorArea.getDoc().setValue(JSON.parse(program));
          this.editorArea.focus();
        }
      }
    
      escapeHTML(str) {
        let out = '';
        for (const c of str + '') {
          if(c === '<')
            out += '&lt;';
          else if(c === '>')
            out += '&gt;';
          else if(c === "'")
            out += '&#39;';
          else if(c === '"')
            out += '&quot;';
          else if(c === '&')
            out += '&amp;';
          else
            out += c;
        }
        return out;
      }
    }

    window.onload = function () { DraftScript.onload(); }
  </script>
  <script src="./turtle.js"></script>
</head>

<body onresize="DraftScript.resizeCanvas();">

<div id="cells" style="font-family: monospace; margin-left: 30px;">
</div>

<div>
<br/>
<input type="button" value="消去" onclick="DraftScript.reset()"/>
<input type="button" value="実行" onclick="DraftScript.run()"/>
&nbsp;
<input type="button" value="保存" onclick="DraftScript.save()"/>
<input type="button" value="読込" onclick="DraftScript.load()"/>
<br/>

<div style="float: left;">
 <div id="editor" style="width: 43em; border: 0.5px solid gray;"></div>
 <br/>
 <div id="output" style="font-family: monospace; margin-left: 30px;">
</div>
</div>

<div style="float: left;">
&nbsp;
</div>

<canvas id="canvas" width=400 height=400
        style="background-color: white; border: 0.5px solid gray;">
</canvas>

<div style="clear: both;"></div>

</body>
</html>
